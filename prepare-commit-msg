#!/bin/bash

# Git hook to append emoji to commit messages
# Requires LLM_API_URL, LLM_MODEL and API key depending on the provider

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

if [ -z "$LLM_API_URL" ]; then
    echo "Warning: LLM_API_URL environment variable is not set, aborting ..." >&2
    exit 0
fi

if [ -z "$LLM_MODEL" ]; then
    echo "Warning: LLM_MODEL environment variable is not set, aborting ..." >&2
    exit 1
fi

# Only process if this is a regular commit (not merge, squash, etc.)
if [ -z "$COMMIT_SOURCE" ] || [ "$COMMIT_SOURCE" = "message" ]; then

    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    if [[ -z "$COMMIT_MSG" ]] then
        echo "Warning: Empty commit message"
        exit 0
    fi

    EMOJI_RESPONSE=$(curl -s "$LLM_API_URL/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -d "{\"model\": \"$LLM_MODEL\", \"messages\": [{\"role\": \"user\", \"content\": \"Respond with only a single emoji that represents this commit: $COMMIT_MSG\"}]}" \
        2>/dev/null)
    CURL_EXIT_CODE=$?

    if [ $CURL_EXIT_CODE -eq 0 ] && [ -n "$EMOJI_RESPONSE" ]; then

        if echo "$EMOJI_RESPONSE" | grep -q '"error"'; then
            echo "Warning: LLM API returned error. Check if model '$LLM_MODEL' is available." >&2
        else
            EMOJI=$(echo "$EMOJI_RESPONSE" | grep -o '"content": *"[^"]*"' | sed 's/"content": *"//;s/"//' | sed 's/\\[a-z]//g' | tr -d ' \n\r')

            if [ -n "$EMOJI" ]; then
                echo "${COMMIT_MSG}${EMOJI}" > "$COMMIT_MSG_FILE"
            else
                echo "Warning: LLM response does not contain emoji. No emoji added." >&2
            fi
        fi
    else
        if [ $CURL_EXIT_CODE -ne 0 ]; then
            echo "Warning: Failed to connect to LLM API at '$LLM_API_URL'. Check if API is accessible." >&2
        else
            echo "Warning: LLM API returned empty response. No emoji added." >&2
        fi
    fi
fi
